<!doctype html>
<html lang="th">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>RR365 Admin</title>
<style>
  body{font-family:system-ui,-apple-system,"Segoe UI",Tahoma,sans-serif;background:#0b0b0b;color:#fff;margin:0;padding:18px}
  .wrap{max-width:1200px;margin:auto}
  .card{background:#141414;border:1px solid rgba(255,60,60,.25);border-radius:14px;padding:14px;margin-bottom:14px}
  h1{margin:0 0 10px}
  label{font-size:12px;color:#ffb3b3}
  input,select{width:100%;padding:10px;border-radius:10px;border:1px solid rgba(255,60,60,.25);background:#000;color:#fff}
  button{padding:10px 12px;border:none;border-radius:10px;font-weight:800;cursor:pointer;background:linear-gradient(135deg,#ff2b2b,#b80000);color:#fff}
  button.ghost{background:#222;border:1px solid rgba(255,60,60,.25)}
  .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  @media(max-width:900px){.grid{grid-template-columns:1fr}}
  .row{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px}
  @media(max-width:900px){.row{grid-template-columns:1fr}}
  table{width:100%;border-collapse:collapse;font-size:12px}
  th,td{border-bottom:1px solid rgba(255,255,255,.08);padding:8px;vertical-align:top}
  th{color:#ffb3b3;text-align:left}
  .ok{padding:10px;border-radius:10px;background:rgba(54,211,153,.12);border:1px solid rgba(54,211,153,.25);margin-top:10px}
  .err{padding:10px;border-radius:10px;background:rgba(255,90,95,.14);border:1px solid rgba(255,90,95,.25);margin-top:10px}
  .pill{display:inline-block;padding:2px 8px;border-radius:999px;border:1px solid rgba(255,60,60,.25);background:#000}
</style>
</head>
<body>
<div class="wrap">
  <h1>RR365 Admin <span class="pill" id="mk">‚Äî</span></h1>

  <div class="card">
    <div class="row">
      <div>
        <label>ADMIN KEY (‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡πÉ‡∏ô Code.gs)</label>
        <input id="key" placeholder="‡πÉ‡∏™‡πà‡∏Ñ‡∏µ‡∏¢‡πå‡∏•‡∏±‡∏ö">
      </div>
      <div>
        <label>WEB APP URL (exec)</label>
        <input id="url" placeholder="https://script.google.com/macros/s/.../exec">
      </div>
      <div style="display:flex;gap:10px;align-items:end">
        <button onclick="loadAll()">‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
        <button class="ghost" onclick="fillFromQuery()">‡∏î‡∏∂‡∏á‡∏à‡∏≤‡∏Å URL</button>
      </div>
    </div>
    <div id="msg"></div>
  </div>

  <div class="grid">
    <div class="card">
      <h3 style="margin:0 0 10px">‚úÖ ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå (Allow)</h3>
      <label>‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£</label>
      <input id="ap_phone" placeholder="0XXXXXXXXX">
      <div class="row">
        <div>
          <label>‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</label>
          <select id="ap_ok">
            <option value="true">TRUE</option>
            <option value="false">FALSE</option>
          </select>
        </div>
        <div>
          <label>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</label>
          <input id="ap_note" placeholder="‡∏ù‡∏≤‡∏Å‡∏Ñ‡∏£‡∏ö‡πÅ‡∏•‡πâ‡∏ß / ‡∏ú‡πà‡∏≤‡∏ô‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç">
        </div>
        <div style="display:flex;gap:10px;align-items:end">
          <button onclick="setApprove()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
        </div>
      </div>
      <div style="font-size:12px;color:#bbb;margin-top:10px">
        * ‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏±‡πâ‡∏á allow = TRUE ‡∏Å‡πà‡∏≠‡∏ô ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏à‡∏∞ ‚Äú‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‚Äù ‡∏ú‡πà‡∏≤‡∏ô
      </div>
    </div>

    <div class="card">
      <h3 style="margin:0 0 10px">‚õî ‡πÅ‡∏ö‡∏ô/‡∏õ‡∏•‡∏î‡πÅ‡∏ö‡∏ô (Blocks)</h3>
      <div class="row">
        <div>
          <label>‡πÄ‡∏ö‡∏≠‡∏£‡πå (‡πÄ‡∏ß‡πâ‡∏ô‡πÑ‡∏î‡πâ)</label>
          <input id="bl_phone" placeholder="0XXXXXXXXX">
        </div>
        <div>
          <label>deviceId (‡πÄ‡∏ß‡πâ‡∏ô‡πÑ‡∏î‡πâ)</label>
          <input id="bl_dev" placeholder="RR365_DEVICE_ID">
        </div>
        <div>
          <label>‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•</label>
          <input id="bl_reason" placeholder="manual / abuse / multi-device">
        </div>
      </div>
      <div style="display:flex;gap:10px;margin-top:10px">
        <button onclick="blockIt()">‡πÅ‡∏ö‡∏ô</button>
        <button class="ghost" onclick="unblockIt()">‡∏õ‡∏•‡∏î‡πÅ‡∏ö‡∏ô</button>
      </div>
      <div style="font-size:12px;color:#bbb;margin-top:10px">
        * auto-block ‡∏à‡∏∞‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ó‡∏±‡πâ‡∏á phone ‡πÅ‡∏•‡∏∞ deviceId ‡∏•‡∏á blocks ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
      </div>
    </div>
  </div>

  <div class="card">
    <h3 style="margin:0 0 10px">üìå Allow</h3>
    <div style="overflow:auto;max-height:300px">
      <table id="t_allow">
        <thead><tr><th>phone</th><th>approved</th><th>note</th><th>updatedAt</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <div class="card">
    <h3 style="margin:0 0 10px">‚õî Blocks</h3>
    <div style="overflow:auto;max-height:300px">
      <table id="t_blocks">
        <thead><tr><th>phone</th><th>deviceId</th><th>reason</th><th>blockedAt</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <div class="card">
    <h3 style="margin:0 0 10px">üì± Devices ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</h3>
    <div style="overflow:auto;max-height:300px">
      <table id="t_devices">
        <thead><tr><th>phone</th><th>deviceId</th><th>status</th><th>firstSeenAt</th><th>lastSeenAt</th><th>note</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <div class="card">
    <h3 style="margin:0 0 10px">üîí Used ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</h3>
    <div style="overflow:auto;max-height:300px">
      <table id="t_used">
        <thead><tr><th>matchKey</th><th>phone</th><th>deviceId</th><th>usedAt</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </div>
</div>

<script>
const $ = id => document.getElementById(id);
const m = (type, text) => $("msg").innerHTML = `<div class="${type}">${text}</div>`;

function fillFromQuery(){
  const u = new URL(location.href);
  const key = u.searchParams.get("key");
  if(key) $("key").value = key;
  $("url").value = location.href.split("?")[0];
}

async function post(action, payload={}){
  const url = $("url").value.trim();
  const key = $("key").value.trim();
  if(!url) throw new Error("‡∏Å‡∏£‡∏≠‡∏Å WEB APP URL ‡∏Å‡πà‡∏≠‡∏ô");
  if(!key) throw new Error("‡∏Å‡∏£‡∏≠‡∏Å ADMIN KEY ‡∏Å‡πà‡∏≠‡∏ô");

  const res = await fetch(url, { method:"POST", body: JSON.stringify({ action, key, ...payload }) });
  const text = await res.text();
  try { return JSON.parse(text); }
  catch { throw new Error("INVALID_JSON: " + text); }
}

function escapeHtml(s){
  return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
}
function renderTable(tid, rows, cols){
  const tb = document.querySelector(`#${tid} tbody`);
  tb.innerHTML = rows.map(r=>`<tr>${cols.map(c=>`<td>${escapeHtml(r[c] ?? "")}</td>`).join("")}</tr>`).join("");
}

async function loadAll(){
  try{
    m("ok","‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...");
    const data = await post("admin_list");
    if(!data.ok) return m("err", data.msg || "‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
    $("mk").textContent = data.matchKey || "‚Äî";

    renderTable("t_allow", data.allow || [], ["phone","approved","note","updatedAt"]);
    renderTable("t_blocks", data.blocks || [], ["phone","deviceId","reason","blockedAt"]);
    renderTable("t_devices", data.devices || [], ["phone","deviceId","status","firstSeenAt","lastSeenAt","note"]);
    renderTable("t_used", data.used || [], ["matchKey","phone","deviceId","usedAt"]);
    m("ok","‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
  }catch(e){
    m("err", e.message || String(e));
  }
}

async function setApprove(){
  try{
    const phone = $("ap_phone").value.trim();
    const approved = $("ap_ok").value;
    const note = $("ap_note").value.trim();
    const data = await post("admin_set_approve", { phone, approved, note });
    if(!data.ok) return m("err", data.msg || "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
    m("ok","‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß");
    await loadAll();
  }catch(e){ m("err", e.message || String(e)); }
}

async function blockIt(){
  try{
    const phone = $("bl_phone").value.trim();
    const deviceId = $("bl_dev").value.trim();
    const reason = $("bl_reason").value.trim() || "manual";
    const data = await post("admin_block", { phone, deviceId, reason });
    if(!data.ok) return m("err", data.msg || "‡πÅ‡∏ö‡∏ô‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
    m("ok","‡πÅ‡∏ö‡∏ô‡πÅ‡∏•‡πâ‡∏ß");
    await loadAll();
  }catch(e){ m("err", e.message || String(e)); }
}

async function unblockIt(){
  try{
    const phone = $("bl_phone").value.trim();
    const deviceId = $("bl_dev").value.trim();
    const data = await post("admin_unblock", { phone, deviceId });
    if(!data.ok) return m("err", data.msg || "‡∏õ‡∏•‡∏î‡πÅ‡∏ö‡∏ô‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
    m("ok","‡∏õ‡∏•‡∏î‡πÅ‡∏ö‡∏ô‡πÅ‡∏•‡πâ‡∏ß");
    await loadAll();
  }catch(e){ m("err", e.message || String(e)); }
}
</script>
</body>
</html>
