<!doctype html>
<html lang="th">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Admin | ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏ó‡∏≤‡∏¢‡∏ú‡∏•‡∏ö‡∏≠‡∏•</title>
<meta name="color-scheme" content="dark"/>

<style>
:root{
  --bg0:#050102; --bg1:#0b0304;
  --card:rgba(255,255,255,.06);
  --line:rgba(255,90,90,.22);
  --line2:rgba(255,90,90,.32);
  --txt:#fff1f1;
  --muted:rgba(255,210,210,.70);
  --accent:#ff2b2b; --accent2:#b80000;
  --ok:#36d399; --bad:#ff5a5f;
  --shadow:0 20px 60px rgba(0,0,0,.65);
  --r14:14px; --r16:16px; --r20:20px;
}
*{box-sizing:border-box}
body{
  margin:0;
  padding:18px 14px 30px;
  font-family:system-ui,-apple-system,"Segoe UI",Tahoma,sans-serif;
  color:var(--txt);
  background:
    radial-gradient(1000px 600px at 20% 0%, rgba(255,0,0,.18), transparent 60%),
    radial-gradient(900px 540px at 80% 10%, rgba(255,0,0,.10), transparent 60%),
    linear-gradient(180deg, var(--bg0), var(--bg1));
}
.wrap{width:min(1100px,100%);margin:0 auto}
.top{
  display:flex;align-items:center;justify-content:space-between;gap:12px;
  margin-bottom:14px;
}
.brand{
  display:flex;align-items:center;gap:10px;
}
.brand .logo{
  width:44px;height:44px;border-radius:14px;
  background:rgba(255,255,255,.06);
  border:1px solid var(--line2);
  display:grid;place-items:center;
  overflow:hidden;
  box-shadow:var(--shadow);
}
.brand .logo img{width:100%;height:100%;object-fit:cover}
.brand .t b{display:block;font-size:14px}
.brand .t span{display:block;font-size:12px;color:rgba(255,210,210,.55)}

.chips{display:flex;gap:10px;flex-wrap:wrap;justify-content:flex-end}
.chip{
  display:inline-flex;align-items:center;gap:8px;
  padding:10px 12px;border-radius:999px;
  border:1px solid var(--line2);
  background:rgba(0,0,0,.18);
  font-size:12px;color:var(--muted);
  user-select:none;
}
.dot{width:8px;height:8px;border-radius:99px;background:var(--ok);box-shadow:0 0 18px rgba(54,211,153,.6)}
.dot.bad{background:var(--bad);box-shadow:0 0 18px rgba(255,90,90,.6)}

.card{
  background:linear-gradient(180deg, rgba(255,255,255,.07), rgba(255,255,255,.03));
  border:1px solid var(--line);
  border-radius:var(--r20);
  overflow:hidden;
  box-shadow:var(--shadow);
}
.cardHead{
  padding:16px;
  border-bottom:1px solid var(--line);
  display:flex;align-items:center;justify-content:space-between;gap:12px;
  flex-wrap:wrap;
}
.hTitle{font-weight:1000;font-size:16px}
.hSub{font-size:12px;color:rgba(255,210,210,.55);margin-top:4px}
.leftHead{display:flex;flex-direction:column}

.controls{
  display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:flex-end;
}
.input{
  padding:12px 12px;border-radius:var(--r14);
  border:1px solid rgba(255,90,90,.22);
  background:rgba(0,0,0,.25);
  color:var(--txt);
  outline:none;
  min-width:220px;
}
.btn{
  border:none;cursor:pointer;
  border-radius:var(--r14);
  padding:12px 14px;
  font-weight:950;font-size:13px;
  transition:.18s ease;
  user-select:none;
}
.btn:active{transform:scale(.99)}
.btnGhost{
  background:rgba(255,255,255,.06);
  color:var(--txt);
  border:1px solid rgba(255,90,90,.18);
}
.btnOk{
  color:#08140f;
  background:linear-gradient(135deg,#58f0b6,#1bbf7a);
}
.btnBad{
  color:#21090b;
  background:linear-gradient(135deg,#ff8a8f,#ff2b2b);
}
.btnMain{
  color:#fff;
  background:linear-gradient(135deg,var(--accent),var(--accent2));
}

.body{padding:14px}

.tableWrap{
  overflow:auto;
  border:1px solid rgba(255,90,90,.18);
  border-radius:var(--r16);
  background:rgba(0,0,0,.18);
}
table{
  width:100%;
  border-collapse:collapse;
  min-width:980px;
}
th,td{
  padding:12px 12px;
  border-bottom:1px solid rgba(255,90,90,.12);
  vertical-align:top;
}
th{
  text-align:left;
  font-size:12px;
  color:rgba(255,210,210,.70);
  position:sticky; top:0;
  background:rgba(0,0,0,.55);
  backdrop-filter: blur(8px);
}
td{font-size:13px;color:rgba(255,240,240,.92)}
.mini{font-size:11px;color:rgba(255,210,210,.55)}
.badgeSt{
  display:inline-flex;align-items:center;gap:8px;
  padding:6px 10px;border-radius:999px;
  border:1px solid rgba(255,90,90,.22);
  background:rgba(0,0,0,.25);
  font-size:12px;
}
.badgeSt.ok{border-color:rgba(54,211,153,.35);background:rgba(54,211,153,.10)}
.badgeSt.pending{border-color:rgba(255,200,90,.35);background:rgba(255,200,90,.10)}
.badgeSt.bad{border-color:rgba(255,90,90,.35);background:rgba(255,90,90,.10)}

.actions{display:flex;gap:8px;flex-wrap:wrap}
.smallBtn{
  padding:10px 12px;border-radius:12px;
  border:none;cursor:pointer;font-weight:950;font-size:12px;
}
.smallBtn.ok{background:linear-gradient(135deg,#58f0b6,#1bbf7a);color:#07150f}
.smallBtn.bad{background:linear-gradient(135deg,#ff8a8f,#ff2b2b);color:#21090b}
.smallBtn.ghost{background:rgba(255,255,255,.06);border:1px solid rgba(255,90,90,.18);color:#fff}

.alert{
  margin-top:12px;
  padding:12px;
  border-radius:var(--r16);
  border:1px solid rgba(255,90,90,.18);
  background:rgba(0,0,0,.18);
  font-size:13px;
  line-height:1.55;
}
.alert.ok{border-color:rgba(54,211,153,.28);background:rgba(54,211,153,.10)}
.alert.err{border-color:rgba(255,90,90,.30);background:rgba(255,90,90,.10)}
.spin{
  width:16px;height:16px;border-radius:99px;
  border:2px solid rgba(255,255,255,.25);
  border-top-color: rgba(255,255,255,.95);
  display:inline-block; animation:rot .7s linear infinite;
  vertical-align:-3px;margin-right:8px;
}
@keyframes rot{to{transform:rotate(360deg)}}
</style>
</head>

<body>
<div class="wrap">
  <div class="top">
    <div class="brand">
      <div class="logo">
        <img src="https://ramruay365.co/wp-content/uploads/2025/12/1735020594-1.png" alt="RR365">
      </div>
      <div class="t">
        <b>Rumruay365 Admin</b>
        <span>‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏ó‡∏≤‡∏¢‡∏ú‡∏•‡∏ö‡∏≠‡∏• (PENDING ‚Üí APPROVED)</span>
      </div>
    </div>

    <div class="chips">
      <div class="chip" title="‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠"><span id="dot" class="dot"></span><span id="conn">‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</span></div>
      <div class="chip" title="‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥">‡∏Ñ‡∏¥‡∏ß‡∏£‡∏≠: <b id="pendingCount">0</b></div>
      <div class="chip" title="‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î">‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï: <b id="lastUpdate">‚Äî</b></div>
    </div>
  </div>

  <section class="card">
    <div class="cardHead">
      <div class="leftHead">
        <div class="hTitle">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå</div>
        <div class="hSub">‡∏Å‡∏î ‚Äú‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‚Äù ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡∏•‡∏î‡∏•‡πá‡∏≠‡∏Å‡πÉ‡∏´‡πâ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ó‡∏≤‡∏¢‡πÑ‡∏î‡πâ (1 ‡∏Ñ‡∏ô/1 ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á)</div>
      </div>

      <div class="controls">
        <input id="q" class="input" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÄ‡∏ö‡∏≠‡∏£‡πå/Device/‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ ‡πÄ‡∏ä‡πà‡∏ô 063... / PENDING">
        <select id="filter" class="input" style="min-width:180px">
          <option value="ALL">‡πÅ‡∏™‡∏î‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
          <option value="PENDING" selected>‡πÄ‡∏â‡∏û‡∏≤‡∏∞ PENDING</option>
          <option value="APPROVED">‡πÄ‡∏â‡∏û‡∏≤‡∏∞ APPROVED</option>
          <option value="REJECTED">‡πÄ‡∏â‡∏û‡∏≤‡∏∞ REJECTED</option>
          <option value="USED">‡πÄ‡∏â‡∏û‡∏≤‡∏∞ USED</option>
          <option value="BLOCKED">‡πÄ‡∏â‡∏û‡∏≤‡∏∞ BLOCKED</option>
        </select>
        <label class="chip" style="cursor:pointer">
          <input id="auto" type="checkbox" checked style="accent-color:#ff2b2b">
          ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏≠‡∏≠‡πÇ‡∏ï‡πâ 10 ‡∏ß‡∏¥
        </label>
        <button id="btnRefresh" class="btn btnMain">üîÑ ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä</button>
      </div>
    </div>

    <div class="body">
      <div class="tableWrap">
        <table>
          <thead>
            <tr>
              <th style="width:160px">‡πÄ‡∏ö‡∏≠‡∏£‡πå</th>
              <th style="width:210px">Device</th>
              <th style="width:120px">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
              <th style="width:180px">‡πÄ‡∏ß‡∏•‡∏≤</th>
              <th>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</th>
              <th style="width:230px">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
            </tr>
          </thead>
          <tbody id="rows">
            <tr><td colspan="6" class="mini">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td></tr>
          </tbody>
        </table>
      </div>

      <div id="msg"></div>

      <div class="alert" style="margin-top:12px">
        <b>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏:</b> ‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ä‡πâ <b>ADMIN_KEY</b> ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏ï‡∏£‡∏á‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡∏Å‡∏î‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥/‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò
      </div>
    </div>
  </section>
</div>

<script>
/* ================== CONFIG (‡πÅ‡∏Å‡πâ‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ) ================== */
const WEB_APP_URL = "‡πÉ‡∏™‡πà‡∏•‡∏¥‡∏á‡∏Å‡πå Web App ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ";
const ADMIN_KEY   = "‡πÉ‡∏™‡πà‡∏£‡∏´‡∏±‡∏™‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ"; // ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏¢‡∏≤‡∏ß‡πÜ‡πÄ‡∏î‡∏≤‡πÑ‡∏°‡πà‡∏≠‡∏≠‡∏Å ‡πÄ‡∏ä‡πà‡∏ô 40+ ‡∏ï‡∏±‡∏ß
/* ========================================================= */

const $ = (id)=>document.getElementById(id);

function setConn(ok, text){
  $("conn").textContent = text || (ok ? "‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô" : "‡∏°‡∏µ‡∏õ‡∏±‡∏ç‡∏´‡∏≤");
  $("dot").className = ok ? "dot" : "dot bad";
}

function alertBox(type, text){
  $("msg").innerHTML = `<div class="alert ${type}">${text}</div>`;
}

function nowStr(){
  const d=new Date();
  const pad=n=>String(n).padStart(2,"0");
  return `${pad(d.getDate())}/${pad(d.getMonth()+1)}/${d.getFullYear()} ${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
}

async function post(body){
  const res = await fetch(WEB_APP_URL, {
    method:"POST",
    headers:{"Content-Type":"text/plain;charset=utf-8"},
    body: JSON.stringify(body)
  });
  const t = await res.text();
  return JSON.parse(t);
}

function stBadge(st){
  const s=String(st||"").toUpperCase();
  if(s==="APPROVED") return `<span class="badgeSt ok">APPROVED</span>`;
  if(s==="PENDING")  return `<span class="badgeSt pending">PENDING</span>`;
  if(s==="USED")     return `<span class="badgeSt ok">USED</span>`;
  if(s==="REJECTED") return `<span class="badgeSt bad">REJECTED</span>`;
  if(s==="BLOCKED")  return `<span class="badgeSt bad">BLOCKED</span>`;
  return `<span class="badgeSt">${s||"‚Äî"}</span>`;
}

function norm(s){ return String(s||"").toLowerCase().trim(); }

let cache=[];

function render(){
  const q = norm($("q").value);
  const f = $("filter").value;

  let list = cache.slice();

  if(f !== "ALL"){
    list = list.filter(x => String(x.status||"").toUpperCase() === f);
  }
  if(q){
    list = list.filter(x => {
      const t = `${x.username||""} ${x.deviceId||""} ${x.status||""} ${x.note||""} ${x.createdAt||""} ${x.updatedAt||""}`;
      return norm(t).includes(q);
    });
  }

  $("pendingCount").textContent = cache.filter(x=>String(x.status||"").toUpperCase()==="PENDING").length;
  $("lastUpdate").textContent = nowStr();

  const tb = $("rows");
  if(!list.length){
    tb.innerHTML = `<tr><td colspan="6" class="mini">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</td></tr>`;
    return;
  }

  tb.innerHTML = list.map(x=>{
    const u = x.username || "-";
    const d = x.deviceId || "-";
    const st= (x.status||"").toUpperCase();
    const time = x.updatedAt || x.createdAt || "-";
    const note = x.note || "";
    const canApprove = (st==="PENDING");
    const canReject  = (st==="PENDING");
    return `
      <tr>
        <td><b>${u}</b></td>
        <td><span class="mini">${d}</span></td>
        <td>${stBadge(st)}</td>
        <td><span class="mini">${time}</span></td>
        <td><span class="mini">${note}</span></td>
        <td>
          <div class="actions">
            <button class="smallBtn ok" ${canApprove?"":"disabled"} onclick="approve('${u}','${d}')">‚úÖ ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</button>
            <button class="smallBtn bad" ${canReject?"":"disabled"} onclick="reject('${u}','${d}')">‚õî ‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò</button>
            <button class="smallBtn ghost" onclick="copyText('${u}')">üìã ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÄ‡∏ö‡∏≠‡∏£‡πå</button>
          </div>
        </td>
      </tr>
    `;
  }).join("");
}

async function refresh(){
  $("btnRefresh").disabled = true;
  $("btnRefresh").innerHTML = `<span class="spin"></span>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...`;
  try{
    // ‚úÖ ‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏ù‡∏±‡πà‡∏á Code.gs ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö action ‡∏ô‡∏µ‡πâ
    const data = await post({action:"admin_list", adminKey: ADMIN_KEY});
    if(!data.ok) throw new Error(data.msg || "‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");

    // ‡∏Ñ‡∏≤‡∏î‡∏´‡∏ß‡∏±‡∏á data.items ‡πÄ‡∏õ‡πá‡∏ô array
    cache = Array.isArray(data.items) ? data.items : [];
    setConn(true, "‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô");
    alertBox("ok", `‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ${cache.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`);
    render();
  }catch(e){
    setConn(false, "‡∏°‡∏µ‡∏õ‡∏±‡∏ç‡∏´‡∏≤");
    alertBox("err", `‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ${String(e.message||e)}`);
  }finally{
    $("btnRefresh").disabled = false;
    $("btnRefresh").textContent = "üîÑ ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä";
  }
}

async function approve(username, deviceId){
  if(!confirm(`‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÄ‡∏ö‡∏≠‡∏£‡πå ${username} ?`)) return;
  try{
    const data = await post({
      action:"admin_approve",
      adminKey: ADMIN_KEY,
      username, deviceId
    });
    if(!data.ok) throw new Error(data.msg||"‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
    alertBox("ok", data.msg || "‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
    await refresh();
  }catch(e){
    alertBox("err", `‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ${String(e.message||e)}`);
  }
}

async function reject(username, deviceId){
  const reason = prompt("‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò (‡πÉ‡∏™‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏ß‡πâ‡∏ô‡∏ß‡πà‡∏≤‡∏á‡πÑ‡∏î‡πâ):","‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç");
  if(reason===null) return;
  try{
    const data = await post({
      action:"admin_reject",
      adminKey: ADMIN_KEY,
      username, deviceId,
      reason
    });
    if(!data.ok) throw new Error(data.msg||"‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
    alertBox("ok", data.msg || "‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
    await refresh();
  }catch(e){
    alertBox("err", `‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ${String(e.message||e)}`);
  }
}

function copyText(t){
  navigator.clipboard?.writeText(String(t||"")).then(()=>{
    alertBox("ok", `‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß: ${t}`);
  }).catch(()=>{
    alertBox("err", `‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à`);
  });
}

$("btnRefresh").addEventListener("click", refresh);
$("q").addEventListener("input", render);
$("filter").addEventListener("change", render);

let timer=null;
function startAuto(){
  clearInterval(timer);
  if($("auto").checked){
    timer=setInterval(refresh, 10000);
  }
}
$("auto").addEventListener("change", startAuto);

// ‡πÇ‡∏´‡∏•‡∏î‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å
refresh().then(startAuto);
</script>
</body>
</html>
